# Kingdee API Development Specification

# 金蝶云·星辰集成应用开发规范

## 1. 引言

### 1.1. 编写目的
*   为保障金蝶云·星辰生态产品的系统稳定、高效运行，规范集成设计与开发，助力星辰生态业务持续健康发展，结合当前多个生态产品的实际研发和系统上线运行的情况和经验，特制定《金蝶云·星辰集成应用开发规范》，以行业领先标准为要求，提升集成开发质量及客户满意度。
*   本篇文档作为 API 开发指导手册，包含四部分规范：**API文档规范、API 调用规范、API 错误码规范和 API 安全规范**。
*   本文档用于指引开发者进行金蝶产品组合集成，提升产品组合的效率和质量。

### 1.2. OpenAPI整体介绍
*   金蝶云·星辰的OpenAPI致力于提供符合Restful规范的接口，将企业数据及业务能力API化，全面覆盖各领域开放接口的使用场景，用户可以简单、安全、低成本地实现内外部系统集成和业务能力的开放。
*   应用程序编程接口（API），是应用程序重要的组成部分，是应用程序对外提供的一个操作数据入口。当客户端调用这个入口，应用程序则会执行对应代码操作，给客户端完成相对应的功能。

### 1.3. 适用范围
*   本办法适用于金蝶软件（中国）有限公司（以下简称“金蝶中国”）总部、下属分公司（以下简称“机构”）及各子公司和ISV伙伴，通过OpenAPI参与星辰&生态集成开发的研发人员。
*   **产品范围**：金蝶云星辰标准版、金蝶云星辰专业版、金蝶云星辰旗舰版。

### 1.4. 参考
*   [《金蝶云苍穹OpenAPI开发规范》](https://vip.kingdee.com/knowledge/specialDetail/226337046514476288?category=450969352477588480&id=367256698861227008)
*   [《金蝶云苍穹OpenAPI接口规范》](https://vip.kingdee.com/knowledge/specialDetail/226337046514476288?category=450969352477588480&id=448792125560557568)

### 1.5. 说明
依据约束力强弱及故障敏感性，规约依次分为 **【强制】** 、 **【推荐】** 两大类。在延伸信息中，“说明”对规约做了适当扩展和解释。

## 2. API文档规范
调用OpenAPI**仅支持HTTPS协议**作为传输协议，以确保传输数据的安全性。默认报文格式为JSON，报文格式由具体服务接口定义。

### 2.1. 请求URL
小微开放平台发布的接口地址为URL，拼接 `https://动态域名/jdy` 组成完整请求地址，形如：`https://api.kingdee.com/jdy/v2/sys/xxxxxx`。

### 2.2. 请求方式
调用接口的请求方式主要有GET和POST。
*   **GET请求**：主要用于向指定的资源发出“显示”请求。**应该只用在获取数据**，但传递的参数显示在地址栏，安全性低，且参数的长度也有限制（2048字符）。
*   **POST请求**：用于向指定资源提交数据，请求服务器进行处理，例如保存单据或基础资料。可能会创建或修改资源。传递的参数放在request body中，安全性比GET请求高，参数**没有长度限制**。

### 2.3. Headers参数规范
每次调用接口都必须传如下headers参数（不区分大小写），**均为【强制】**。

| 参数名称 | 参考示例 | 说明 |
| :--- | :--- | :--- |
| `Content-Type` | `application/json` | 请求类型，**固定值**为 `application/json`。 |
| `X-Api-ClientID` | `205022` | 应用ID，开发者后台创建应用获取。[查看**创建指引**](https://open.jdy.com/#/files/api/detail?index=3&categrayId=316e1f5bd9d711ed8e36c17691e84ff5&id=a540e3dcd9d811ed8e3677dc79b66e86) |
| `X-Api-Auth-Version` | `2.0` | 接口版本号，**固定值**为 `2.0`。 |
| `X-Api-TimeStamp` | `1655775240000` | 当前时间的**毫秒级**时间戳，长度为13位的数字。 |
| `X-Api-SignHeader` | `X-Api-TimeStamp,X-Api-Nonce` | 参与签名的headers参数名称，**固定值**为 `X-Api-TimeStamp,X-Api-Nonce`。 |
| `X-Api-Nonce` | `1655775240000` | 随机正整数，用于预防CSRF攻击。 |
| `X-Api-Signature` | `xxx` | 签名串，按一定规则生成的签名校验字符串。[查看**加密规则**](https://open.jdy.com/#/files/api/detail?index=4&categrayId=5403e0fd6a5811eda819b759130d6d33&id=b5c26557da9d11ed8e36f9799578d2e1) |
| `app-token` | `xxx` | 业务接口的token，绑定账套后生成。[查看**获取指引**](https://open.jdy.com/#/files/api/detail?index=3&categrayId=5403e0fd6a5811eda819b759130d6d33&id=9076d1a6da9d11ed8e36874bed64e0be&noside=true) |
| `X-GW-Router-Addr` | `https://tf.jdy.com/` | OpenAPI的后端地址——**IDC域名**。从获取授权信息或[**实时接收授权**](https://open.jdy.com/#/files/api/detail?index=4&categrayId=5403e0fd6a5811eda819b759130d6d33&id=78574825da9d11ed8e36c1d0700f007b)返回的 `domain` 字段获取。 |

### 2.4. 响应参数规范
每次调用接口的HTTP Status Code为**200 OK**时，都会返回如下参数。

| 参数 | 说明 |
| :---: | :--- |
| `errcode` | **业务返回码**：业务处理成功返回码为 **`0`**；业务处理失败返回码大于 `0`。 |
| `description` | **业务处理结果描述**：成功返回 `success`；失败返回具体原因。 |
| `data` | **业务处理结果对象**：业务返回的具体数据对象。 |

## 3. API调用规范
为保证接口可靠性和稳定性，客户端在调用时应遵守以下【强制】规范。

| 调用方规范 | 规范说明 |
| :--- | :--- |
| **Token 及认证** | 目前支持2种认证方式：`app-token`认证和签名认证（`X-Api-Signature`）。`app-token`有效期一般为**24小时**，客户端应**缓存**`app-token`，不应每次调用API时重复请求获取，即将过期时可通过刷新token换取新的`app-token`。 |
| **重复调用控制** | 请求header中的 `X-Api-TimeStamp` 为当前时间毫秒时间戳，该值**5分钟内有效**。当同一请求第二次访问时，若时间戳超过5分钟，系统会拒绝请求，防止重复提交。 |
| **请求数据量控制** | 单次调用最长响应时间不得超过**30秒**。大数据量处理必须做好分页控制：<br/>- 单次查询请求（包含分录）不得超过 **1000条**。<br/>- 保存请求不得超过 **500条**。 |
| **请求频次限制** | 每个接口默认 **400次/秒**，最大 **1000次/秒**。 |

## 4. API错误码规范
方便快速定位接口问题，保证用户统一的API使用体验。

### 4.1. 网关标准错误码规范
遵循集团网关统一错误码，范围从 **0 – 999**。

| 类别 | 错误码 | 描述 |
| :--- | :---: | :--- |
| 网关标准错误码 | 0 | OK - 请求成功 |
| 网关标准错误码 | 400 | 参数无效 - 请求参数有误或缺失 |
| 网关标准错误码 | 401 | 未授权访问（Token 无效） |
| 网关标准错误码 | 403 | 禁止访问（IP 限制等） |
| 网关标准错误码 | 404 | API 不存在 - 请求的 API 不存在 |
| 网关标准错误码 | 429 | API 被限流 - 请求过于频繁 |
| 网关标准错误码 | 500 | 服务异常，服务内部错误 |
| 网关标准错误码 | 503 | 服务暂时不可用，例如：停机维护 |
| 网关标准错误码 | 504 | 请求的服务超时 - 等待服务响应超时 |

### 4.2. 业务领域错误码规范
错误码总共10位十进制（数字），采用4段式定义（形如：**AABBCCDEEE**），范围 **2000000000 – 2999999999**：
*   **第1段的AA**：代表产品系统。**20** - 星辰
*   **第2段的BB**：代表不同产品系统下各服务。例如：00-默认、11-系统云、12-开发服务云、13-流程服务云、14-数据服务云、15-财务云、16-供应链云、17-订货云、18-零售云、19-小微管理中心、20-业务中台
*   **第3段的CC**：代表产品服务下子模块。00 – 默认
*   **第4段的D**：代表最上级解决角色。1 – 运维、2 – 开发者、3– 客户
*   **第5段的EEE**：代表具体错误编码。

| 类别 | 错误码范围 | 示例 |
| :--- | :--- | :--- |
| 业务领域错误码 | `2000000000 - 2999999999` | `2015002000` – 财务云系统错误；`2016002095` – 第%d 行分录的商品和外部商品至少录入一个 |

### 4.3. 共用返回码
实际接口返回信息内容可能并不与“含义”完全一致，但基本含义不变。

| 返回码 | 描述 | 建议处理方案 |
| :--- | :--- | :--- |
| `1000002001` | 服务异常 | - |
| `1020002008` | 用户授权信息有误 | 确认appKey是否正确 |
| `1030002000` | {{必填字段}}不能为空 | - |
| `1030002001` | {{字段}} 类型不正确，请根据字段要求正确传输有效值 | - |
| `1030002002` | {{对象}}已存在，不能重复新增 | - |
| `1030002003` | {{对象\类型\属性}}不存在 | - |
| `1030002004` | {{对象\类型\属性}} 已被其他对象使用，无法删除 | - |
| `1030002005` | 操作对象个数超出限制 | - |
| `1030002006` | {{字段}}格式不正确，请根据字段要求正确传输有效值 | - |
| `1040002000` | 配置有误，请正确配置XXX | 联系工作人员配置client |
| `1040003000` | 请前往XXX进行配置 | 客户自行操作配置 |

### 4.4. 业务返回码示例

| 返回码 | 含义 | 建议处理方案 |
| :--- | :--- | :--- |
| `2000002000` | 星辰系统错误，请到开发者社区提单反馈+traceId | [https://vip.kingdee.com/developer?productLineId=29](https://vip.kingdee.com/developer?productLineId=29) |
| `2011002000` | 星辰系统云系统错误，请到开发者社区提单反馈+traceId | [https://vip.kingdee.com/developer?productLineId=29](https://vip.kingdee.com/developer?productLineId=29) |
| `2015002000` | 星辰财务云系统错误，请到开发者社区提单反馈+traceId | [https://vip.kingdee.com/developer?productLineId=29](https://vip.kingdee.com/developer?productLineId=29) |
| `2016002000` | 星辰供应链云系统错误，请到开发者社区提单反馈+traceId | [https://vip.kingdee.com/developer?productLineId=29](https://vip.kingdee.com/developer?productLineId=29) |
| `2016002095` | 第%d行分录的商品和外部商品至少录入一个 | - |
| `2016002096` | 第%s行分录的商品和外部商品[%s]不匹配，请检查 | - |
| `2016002097` | 第%s行分录的外部商品[%s]未匹配到商品，请检查所传供应商、外部商品等是否正确 | - |
| `2016002098` | 根据外部商品[%s]的外部单位[%s]，未匹配到系统商品单位，请检查 | - |
| `2016002099` | 外部商品[%s]的外部单位为空，请先维护对应的外部单位 | - |
| `2016012098` | 供应商不存在，请检查所传供应商是否正确 | - |
| `2016012099` | 供应商必填 | - |
| `2016022099` | 客户必填 | - |
| `2016003063` | 汇率不能为零 | - |
| `2016043007` | 预收款单的源单类型必须是销售订单 | - |
| `2016043008` | 预付款单的源单类型必须是采购订单 | - |
| ... | ... | ... |

---