# Axiom MES 智能生产系统 - Cursor 项目规则

## 项目概述
MES 智能生产管理系统，面向制造企业的全流程生产执行管理平台。采用微服务架构，容器化部署，强调可观测性与高可用。

## 技术栈版本锁定
- **后端**: Python 3.14-slim, FastAPI 0.115.x, SQLAlchemy 2.0.x, Celery 5.5.x, Prefect 2.19.x, Pydantic 2.x
- **前端**: Vue 3.4.x, Vite 5.x, Element Plus 2.x, Pinia 2.x, TypeScript 5.x, Node.js 24.13.1-alpine
- **数据库**: PostgreSQL 18-alpine, TimescaleDB 2.25.1-pg18, Redis 8.6.0-alpine, MinIO RELEASE.2025-09-07
- **消息队列**: RabbitMQ 3.13-management
- **网关**: Traefik v3.6.8
- **监控**: Prometheus v3.9.1, Grafana 12.4.0, Loki 3.6.6, Tempo 2.9.1, Alertmanager v0.31.1
- **部署**: Docker, Docker Compose (开发/测试), Kubernetes (生产推荐)

## 目录结构规范

### 后端 (`backend/`)
```
backend/
├── src/
│   ├── {domain}/           # 业务域（auth, strategy, schedule...）
│   │   ├── router.py       # 路由
│   │   ├── schemas.py      # Pydantic 模型
│   │   ├── models.py       # SQLAlchemy 模型
│   │   ├── service.py      # 业务逻辑
│   │   ├── dependencies.py # 依赖项
│   │   ├── exceptions.py   # 域异常
│   │   ├── constants.py    # 常量
│   │   ├── utils.py        # 工具函数
│   │   └── tasks.py        # Celery 任务
│   ├── core/               # 通用核心层
│   │   ├── config.py       # 全局配置（Pydantic Settings）
│   │   ├── database.py     # 数据库会话
│   │   ├── security.py     # 安全工具
│   │   ├── logging.py      # 日志配置
│   │   ├── exceptions.py   # 全局异常基类
│   │   └── response.py     # 统一响应格式
│   ├── tasks/              # Celery 应用配置
│   ├── workflows/          # Prefect 工作流配置
│   ├── rules/              # 规则引擎核心
│   ├── utils/              # 全局工具
│   └── main.py             # FastAPI 应用入口
├── tests/                  # 测试（镜像业务域结构）
├── requirements/           # 依赖拆分
├── alembic/                # 数据库迁移
└── .env.example
```

### 前端 (`frontend/`)
```
frontend/
├── src/
│   ├── assets/
│   ├── components/         # 公共组件（common/, business/）
│   ├── views/              # 页面组件
│   ├── stores/             # Pinia stores
│   ├── router/             # 路由
│   ├── api/                # API 接口封装
│   ├── utils/              # 工具函数
│   ├── styles/             # 全局样式
│   ├── types/              # TypeScript 类型
│   ├── App.vue
│   └── main.ts
├── public/
├── index.html
├── vite.config.ts
└── package.json
```

## 代码规范

### 后端 (Python)
- **风格**: PEP 8, 行长度 120, 使用 `black` 格式化
- **类型注解**: 必须启用 mypy 严格模式，禁止使用 `Any`
- **文档字符串**: Google 风格，包含参数、返回值、异常
- **导入顺序**: 标准库 → 第三方 → 本地模块，每组空一行
- **异步**: I/O 密集型使用 `async/await`，CPU 密集型使用 Celery
- **异常**: 使用自定义异常类（继承 `DomainError`），避免裸抛 `Exception`
- **配置**: 使用 Pydantic `BaseSettings`，敏感信息从环境变量读取

### 前端 (Vue 3 + TypeScript)
- **风格**: Prettier 默认配置（单引号、无分号、缩进2空格）
- **TypeScript**: 严格模式，禁止 `any`，使用 `unknown` 或类型守卫
- **组件**: 组合式 API (`<script setup>`)，文件名 kebab-case，组件名 PascalCase
- **Props**: 定义类型、默认值、验证
- **事件**: kebab-case 命名
- **状态管理**: Pinia，每个 Store 独立文件
- **样式**: SCSS，BEM 命名，尽量使用 scoped 或 CSS Modules

## 命名规范

| 类型                | 规范                           | 示例                     |
| ------------------- | ------------------------------ | ------------------------ |
| 后端模块/包         | snake_case                     | `auth`, `strategy_exec`  |
| 后端类              | PascalCase                     | `UserService`            |
| 后端函数/变量       | snake_case                     | `get_user_by_id`         |
| 后端常量            | UPPER_SNAKE_CASE               | `MAX_RETRY_COUNT`        |
| 后端异常类          | 以 `Error` 结尾，PascalCase    | `UserNotFoundError`      |
| Pydantic 模型       | PascalCase, 响应加 `Response`   | `UserCreate`, `UserResponse` |
| SQLAlchemy 模型     | PascalCase, 单数                | `User`, `Strategy`       |
| 前端组件文件名      | kebab-case                      | `user-profile.vue`       |
| 前端组件名（代码）  | PascalCase                      | `UserProfile`            |
| 前端变量/函数       | camelCase                       | `userName`, `fetchData`  |
| 前端常量            | UPPER_SNAKE_CASE                | `API_BASE_URL`           |
| Pinia Store         | camelCase, 以 `use` 开头 `Store`结尾 | `useAuthStore`      |
| 路由路径            | kebab-case                      | `/user-profile`          |
| 数据库表名          | 小写复数，下划线分隔             | `users`, `strategies`    |
| 数据库字段          | 小写下划线分隔                   | `created_at`, `user_id`  |
| 主键                | `id`                            |                          |
| 外键                | 单数表名 + `_id`                 | `user_id`                |
| 索引名              | `idx_表名_字段名`                 | `idx_users_email`        |
| API 路由            | 名词复数，RESTful                | `/api/v1/strategies`     |

## API 设计规范
- **RESTful**: 使用 HTTP 方法表示操作，资源路径为名词复数
- **版本**: URL 路径中包含版本号，如 `/api/v1/...`
- **请求/响应**: 统一 JSON 格式，响应包裹在 `data` 字段，错误使用 `error`
  ```json
  { "code": 200, "message": "success", "data": { ... } }
  { "code": 400, "message": "Invalid parameter", "error": { ... } }
  ```
- **分页**: 请求参数 `page`, `page_size`；响应包含 `pagination` 对象
- **错误码**: 自定义5位数字，前两位模块，后三位具体错误

## 数据库规范
- 所有表必须有 `id` (PK), `created_at`, `updated_at` (timestamptz)
- 字段禁止 `NULL`，使用默认值
- 索引：为外键、频繁查询字段创建
- TimescaleDB：超表按时间分区，启用压缩，创建连续聚合视图

## 安全规范
- **认证**: OAuth2 + JWT，短生命周期，刷新令牌
- **授权**: RBAC，依赖项注入验证权限
- **密码**: bcrypt 哈希
- **加密**: 敏感数据 AES-256 加密，密钥由 KMS 管理
- **传输**: 全站 HTTPS (Traefik 自动管理 Let's Encrypt)
- **输入校验**: Pydantic 严格校验，防止注入
- **审计**: 敏感操作记录审计日志（独立存储）

## 日志规范
- 结构化 JSON 格式，包含 `timestamp`, `level`, `service`, `trace_id`, `module`, `message`, `context`
- 级别: DEBUG, INFO, WARNING, ERROR, CRITICAL
- 采集: Promtail → Loki，保留30天
- 审计日志额外存 Elasticsearch 或对象存储，保留1年以上

## 测试规范
- **单元测试**: pytest，覆盖率 >70%
- **集成测试**: Testcontainers 启动真实依赖
- **E2E 测试**: Cypress/Playwright
- **性能测试**: Locust/JMeter
- 测试文件位置: `tests/` 镜像业务域结构

## 部署与配置
- 容器化: 多阶段 Dockerfile，非 root 用户运行
- 环境变量: `.env` 文件（开发）或 Kubernetes Secret（生产）
- 健康检查: 每个服务实现 `/health` 端点
- 配置管理: 默认配置 + 环境变量覆盖，敏感信息用 Vault/KMS

## AI 生成代码要求
- 严格遵循上述所有规范
- 生成代码后自动添加符合规范的注释
- 对于不确定的部分，优先参考项目现有代码风格
- 每次修改保持与整体架构一致
```

---